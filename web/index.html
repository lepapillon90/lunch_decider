<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="점심결정사">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>점심결정사</title>
  <link rel="manifest" href="manifest.json">
  <script>
    window.kakaoKey = 'e232b750f214ced5524f480a11662743';
    
    window.handleScriptError = function() {
        console.error("Failed to load Kakao Map SDK script.");
        var container = document.querySelector('[id^="map-"]');
        if (container) {
            container.innerHTML = '<div style="padding:20px; color:red; background:#fff;">❌ 카카오맵 SDK 로드 실패. [도메인 등록] 또는 [인터넷 연결]을 확인해주세요.<br>현재 도메인: ' + window.location.origin + '</div>';
        }
    };

    // Dynamically load Kakao Maps SDK
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + window.kakaoKey + '&libraries=services,clusterer&autoload=false';
    script.onerror = window.handleScriptError;
    script.onload = function() {
        console.log("Kakao Map SDK script tag loaded successfully.");
    };
    document.head.appendChild(script);

    window.initKakaoMap = function(elementId, lat, lng, markerName) {
      function tryInit(attempts) {
        var container = document.getElementById(elementId);
        if (attempts <= 0) {
            console.error("Failed to load Kakao Map SDK after multiple attempts.");
            if (container) {
                container.innerHTML = '<div style="padding:20px; color:red; background:#fff;">❌ 지도 로딩 시간 초과.<br>1. 카카오 설정에 <b>' + window.location.origin + '</b> 등록 확인<br>2. 키가 <b>JavaScript 키</b>인지 확인</div>';
            }
            return;
        }

        if (typeof kakao === 'undefined' || typeof kakao.maps === 'undefined') {
          setTimeout(function() { tryInit(attempts - 1); }, 200);
          return;
        }

        console.log("Kakao object found, calling kakao.maps.load...");
        kakao.maps.load(function() {
            if (!container) return;

            try {
                container.innerHTML = ''; 
                var options = {
                    center: new kakao.maps.LatLng(lat, lng),
                    level: 3
                };
                var map = new kakao.maps.Map(container, options);
                
                setTimeout(function() {
                    map.relayout();
                    map.setCenter(new kakao.maps.LatLng(lat, lng));
                }, 500);

                var markerPosition  = new kakao.maps.LatLng(lat, lng); 
                var marker = new kakao.maps.Marker({
                    position: markerPosition
                });
                marker.setMap(map);

                if (markerName) {
                    var iwContent = '<div style="padding:5px; white-space:nowrap;">' + markerName + '</div>';
                    var infowindow = new kakao.maps.InfoWindow({
                        content : iwContent
                    });
                    infowindow.open(map, marker);
                }
            } catch (e) {
                console.error("Kakao Map init error: ", e);
                container.innerHTML = '<div style="padding:20px; color:red; background:#fff;">❌ 지도 초기화 에러: ' + e.message + '</div>';
            }
        });
      }
      
      tryInit(30); // Increased attempts to 30
    }
  </script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
